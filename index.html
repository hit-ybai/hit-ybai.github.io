<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>White</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="Bai, Yu">
  
  
  <meta property="og:type" content="website">
<meta property="og:title" content="White">
<meta property="og:url" content="http://www.everkeyword.com/index.html">
<meta property="og:site_name" content="White">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="White">
  
    <link rel="alternate" href="/atom.xml" title="White" type="application/atom+xml">
  
  
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdn.bootcss.com/html5shiv/3.7.0/html5shiv.min.js"></script><![endif]-->
  
  
</head>
<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">White</a></h1>
    <p><a href="/">There&#39;s no magic in this world.</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/about">About</a></li>
      
        <li><a href="/Links">Links</a></li>
      
      
        <li><a href="/atom.xml">RSS</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content">




  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/05/18/2016-05-18-charlie-munger-on-the-psychology-of-human-misjudgment-three/">
  <time datetime="2016-05-18T01:19:27.000Z">
    2016-05-18
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2016/05/18/2016-05-18-charlie-munger-on-the-psychology-of-human-misjudgment-three/">人类误判心理（3）</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>作者：查理·芒格</p>
<h3 id="Third-incentive-cause-bias-both-in-one’s-own-mind-and-that-of-ones-trusted-advisor-where-it-creates-what-economists-call-‘agency-costs-’"><a href="#Third-incentive-cause-bias-both-in-one’s-own-mind-and-that-of-ones-trusted-advisor-where-it-creates-what-economists-call-‘agency-costs-’" class="headerlink" title="Third: incentive-cause bias, both in one’s own mind and that of ones trusted advisor, where it creates what economists call ‘agency costs.’"></a>Third: incentive-cause bias, both in one’s own mind and that of ones trusted advisor, where it creates what economists call ‘agency costs.’</h3><p><strong>第三条：由激励导致的偏见，同时存在于每个人和其所信赖的顾问的脑海中，它造就了经济学家所谓的「代理成本」（agency costs）</strong></p>
<p><em>Here, my early experience was a doctor who sent bushel baskets full of normal gall bladders down to the pathology lab in the leading hospital in Lincoln, Nebraska. And with that quality control for which community hospitals are famous, about five years after he should’ve been removed from the staff, he was. And one of the old doctors who participated in the removal was also a family friend, and I asked him: I said, “Tell me, did he think, ‘Here’s a way for me to exercise my talents’” – this guy was very skilled technically– “’and make a high living by doing a few maimings and murders every year, along with some frauds?’” And he said, “Hell no, Charlie. He thought that the gall bladder was the source of all medical evil, and if you really love your patients, you couldn’t get that organ out rapidly enough.”</em></p>
<p>之前在 Lincoln, Nebraska 的一家顶级医院中，有一名医生经常提着装了一篮子「一切正常」的胆囊到病理学实验室，五年之后，他被这家以质量闻名的社区医院开除了。</p>
<p>有一位当时参与了做出开除决定的老医生，是家里的朋友。我问他:『是不是这人觉得自己技术不错，通过致残、杀害和欺诈一些人，来施展自己的「才华」，过上土豪的生活？』。</p>
<p>老医生回答说：「当然不是，他认为胆囊是医疗隐患，如果你真的爱你的病人，就要用最快的速度把这个它从他体内取出。」</p>
<p><em>未完待续</em></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/11/13/2015-11-13-the-core-value-of-sde/">
  <time datetime="2015-11-13T14:03:27.000Z">
    2015-11-13
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/11/13/2015-11-13-the-core-value-of-sde/">软件工程师的核心价值</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="高效完成产品需求"><a href="#高效完成产品需求" class="headerlink" title="高效完成产品需求"></a>高效完成产品需求</h2><p>用最少的时间完成PM的需求，<strong>用更多的时间去接触新技术，制造（学习）工具，提高效率，享受生活</strong>。</p>
<h2 id="提取工作重复部分-DRY"><a href="#提取工作重复部分-DRY" class="headerlink" title="提取工作重复部分 (DRY)"></a>提取工作重复部分 (DRY)</h2><p>提取工作中的重复部分，独立维护。写的代码越多，需要维护的代码就越多，所以要尽量减少代码冗余（据嗣彬同学说，邓公在FW内部培训的时候也表达过类似的观点）。<br><img src="http://7xjra1.com1.z0.glb.clouddn.com/more_code_more_error.jpg" alt="Code and Error"></p>
<h2 id="将系统抽象成模型"><a href="#将系统抽象成模型" class="headerlink" title="将系统抽象成模型"></a>将系统抽象成模型</h2><p>把复杂的东西讲得简单，难的东西讲得容易，让他人和未来的自己能流畅地了解一个系统。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><p><em><a href="http://www.cppblog.com/vczh/archive/2014/07/15/207658.html" target="_blank" rel="external">靠谱的代码和DRY</a></em></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/10/15/2015-10-15-b-tree/">
  <time datetime="2015-10-15T10:55:27.000Z">
    2015-10-15
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/10/15/2015-10-15-b-tree/">B-Tree</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>如果一个内部节点 <em>X</em> 包含了 <em>n</em> 个有序关键字，那么节点 <em>X</em> 有 <em>n + 1</em> 个子节点，每个叶节点有相同的深度即树的高度。</p>
<p>节点 <em>X</em> 由其关键字分隔为 <em>n + 1</em> 个子域，每个子域和一个子树相对应。在对一个关键字进行搜索时，会通过比较节点中关键字，进行 <em>n + 1</em> 路选择遍历查找。</p>
<p><img src="http://7xjra1.com1.z0.glb.clouddn.com/b-tree.png" alt="B-Tree"></p>
<p>节点中关键字的个数存在上下界，用<code>B-Tree</code>的最小度数 <em>t &gt;= 2</em> 来表示。非根节点至少有 <em>t - 1</em> 个关键字，即有 <em>t</em> 棵子树；至多有 <em>2t - 1</em> 个关键字，即有 <em>2t</em> 棵子树，这时我们称这个节点是满的。当 <em>t = 2</em> 时，每个内部节点有 2 个、 3 个或 4 个子树，即一棵 <em>2-3-4 树</em>。</p>
<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><h3 id="B-TREE-SEARCH"><a href="#B-TREE-SEARCH" class="headerlink" title="B-TREE-SEARCH"></a>B-TREE-SEARCH</h3><p><code>class BTree</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(key)</span></span></div><div class="line">  b_tree_search(@root, key)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">b_tree_search</span><span class="params">(node = <span class="literal">nil</span>, search_key)</span></span></div><div class="line">  <span class="keyword">return</span> <span class="literal">nil</span> <span class="keyword">unless</span> node</div><div class="line">  node.keys.each_with_index <span class="keyword">do</span> <span class="params">|key, idx|</span></div><div class="line">    <span class="keyword">return</span> [node, idx] <span class="keyword">if</span> search_key == key</div><div class="line">    <span class="keyword">next</span> <span class="keyword">if</span> search_key &gt; key</div><div class="line">    b_tree_search(node.child[idx], key)</div><div class="line">    <span class="keyword">break</span></div><div class="line">  <span class="keyword">end</span></div><div class="line">  b_tree_search(node.child.last, key)</div><div class="line">  <span class="literal">nil</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<h3 id="B-TREE-CREATE"><a href="#B-TREE-CREATE" class="headerlink" title="B-TREE-CREATE"></a>B-TREE-CREATE</h3><p><code>class Node</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></div><div class="line">  @leaf  = <span class="literal">true</span></div><div class="line">  @keys  = []</div><div class="line">  @child = []</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p><code>class BTree</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></div><div class="line">  @root = Node.new</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<h3 id="插入关键字"><a href="#插入关键字" class="headerlink" title="插入关键字"></a>插入关键字</h3><p>我们无法直接新建一个叶节点，把关键字插入其中（这样的<code>B-Tree</code>可能是不合法的），所以我们会把新的关键字插入到已有的节点中。不过这样可能会导致一个节点关键字的数量超过它的上界，所以我们引入一个新的操作：分裂<code>B-Tree</code>中的节点。</p>
<h3 id="B-TREE-SPLIT-CHILD"><a href="#B-TREE-SPLIT-CHILD" class="headerlink" title="B-TREE-SPLIT-CHILD"></a>B-TREE-SPLIT-CHILD</h3><p><img src="http://7xjra1.com1.z0.glb.clouddn.com/b-tree-split-child.png" alt="B-TREE-SPLIT-CHILD"><br><code>class BTree</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">b_tree_split_node</span><span class="params">(node, pos)</span></span></div><div class="line">  new_child = Node.new</div><div class="line">  old_child = node.child[pos]</div><div class="line"></div><div class="line">  new_child.leaf  = old_child.leaf</div><div class="line">  new_child.keys  = old_child.pop(@t - <span class="number">1</span>)</div><div class="line">  new_child.child = old_child.pop(@t)</div><div class="line"></div><div class="line">  node.insert_child( new_child, pos + <span class="number">1</span> )</div><div class="line">  node.insert_key( old_child.keys.pop, pos )</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/06/28/2015-06-26-rails-request-to-response-two/">
  <time datetime="2015-06-28T10:55:27.000Z">
    2015-06-28
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/06/28/2015-06-26-rails-request-to-response-two/">[Rails] 从Request到Response（2）</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p><em>本文翻译自：<a href="http://andrewberls.com/blog/post/rails-from-request-to-response-part-2--routing" target="_blank" rel="external">Rails from Request to Response 系列</a>；个人选择了自己感兴趣的部分进行翻译，需要阅读原文的同学请戳前面的链接。</em></p>
<h2 id="第二部分-路由（Routing）"><a href="#第二部分-路由（Routing）" class="headerlink" title="第二部分 路由（Routing）"></a>第二部分 路由（Routing）</h2><p>Blog::Application.routes 的定义也在 engine.rb 文件中：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/railties/lib/rails/engine.rb</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">routes</span></span></div><div class="line">  @routes <span class="params">||</span>= ActionDispatch::Routing::RouteSet.new</div><div class="line">  @routes.append(&amp;Proc.new) <span class="keyword">if</span> block_given?</div><div class="line">  @routes</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>Blog::Application.routes 会返回一个 ActionDispatch::Routing::RouteSet 的实例。这是我们第一次接触到 ActionDispatch 模块（module），它是 ActionPack 的一部分。</p>
<p>ActionDispatch ：<br>负责处理例如「路由（Routing）」，「参数解析（Parameter Parsing）」，「Cookies」和「Sessions」之类的工作；</p>
<p>ActionPack ：<br>Rails 源码的顶层的 gem 之一，功能包括：路由功能， controller （ActionController）的定义和 view （ActionView）的渲染；</p>
<p>RouteSet ：<br>此类是一个Route的集合，包括一个 route 的数组（Mapper），和一个 named route （NamedRouteCollection： name 对应着一组普通的 route 集合的Hash）。负责解释和分派请求（Request）到对应的控制器（Controller）动作（Action）。</p>
<p>现在继续来看 engine ，回到 RouteSet 的 #call 方法，相关的代码在 <em>actionpack/lib/action_dispatch/routing/route_set.rb</em> 中：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/actionpack/lib/action_dispatch/routing/route_set.rb</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActionDispatch</span></span></div><div class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Routing</span></span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RouteSet</span></span></div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></div><div class="line">        @router.call(env)</div><div class="line">      <span class="keyword">end</span></div><div class="line"></div><div class="line">      ...</div><div class="line"></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>RouteSet 不会处理 @router 里的事情。如果我们看一下 <a href="https://github.com/rails/rails/blob/0dea33f770305f32ed7476f520f7c1ff17434fdc/actionpack/lib/action_dispatch/routing/route_set.rb#L299" target="_blank" rel="external">RouteSet constructor</a>，会发现 @router 其实是 Journey::Router 的一个实例。</p>
<h3 id="Journey"><a href="#Journey" class="headerlink" title="Journey"></a>Journey</h3><p>Journey 是 ActionDispatch 的核心路由模块。它的<a href="https://github.com/rails/rails/tree/0dea33f770305f32ed7476f520f7c1ff17434fdc/actionpack/lib/action_dispatch/journey" target="_blank" rel="external">代码</a>是非常有趣的，其中用到了广义状态转移图（generalized transition graph）和非确定性有限状态自动机（non-deterministic finite automata）来配对URLs和路由。</p>
<p>有兴趣的话可以拿出你的计算机科学与技术本科的教科书（译注：指的应是《形式语言与自动机》）复习一下！Journey 甚至还包含了一个完整的 <a href="https://github.com/rails/rails/blob/0dea33f770305f32ed7476f520f7c1ff17434fdc/actionpack/lib/action_dispatch/journey/parser.y" target="_blank" rel="external">yacc 语法文件</a>来对 routes 进行语法分析。</p>
<p>Journey::Router 的 #call 方法有些长，下面是相关部分：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/actionpack/lib/action_dispatch/journey/router.rb</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActionDispatch</span></span></div><div class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Journey</span></span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Router</span></span></div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></div><div class="line">        find_routes(env).each <span class="keyword">do</span> <span class="params">|match, parameters, route|</span></div><div class="line">          env[@params_key] = (set_params <span class="params">||</span> &#123;&#125;).merge parameters</div><div class="line">          status, headers, body = route.app.call(env)</div><div class="line">          <span class="keyword">return</span> [status, headers, body]</div><div class="line">        <span class="keyword">end</span></div><div class="line">      <span class="keyword">end</span></div><div class="line"></div><div class="line">      ...</div><div class="line"></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>我们看到了和 Unicorn 中 #process_client 一样的 Rack 接口。 #find_routes 通过路由表 GTG (generalized transition graph) simulator 对URL进行执行。路由表本身是由 config/routes.rb 中规定的路由信息，构造的一个 Journey::Routes 实例，它包含了全部的路由（多个 Journey::Route 实例），个人十分推荐通过 <em>RailsCasts</em> <a href="http://railscasts.com/episodes/231-routing-walkthrough" target="_blank" rel="external">#231</a>和<a href="http://railscasts.com/episodes/232-routing-walkthrough-part-2" target="_blank" rel="external">#232</a>来学习路由结构的更多细节。</p>
<p>倘若发现了匹配的路由，我们便调用与 route 相关联的 app 上的 #call 方法。只要我们现在在 Rails 源码中看到引用 app 的地方，就可以假定它是 Rack app 。其实每个 controller 中 action 的行为都和一个 Rack app 一样。与 route 相关联的 app 的初始化过程有一些 Tricky。</p>
<p>在构造路由表时， ActionDispatch::Routing::Mapper 类调用 add_route ，它将会构造 Journey::Route 的一个实例，与 controller endpoint  ——  the Rack app 相关联。</p>
<p>然而，在  mapper.rb  中这个类的定义有将近 2,000 行，以下是删减版的 Mapper#add_route 定义：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/actionpack/lib/action_dispatch/routing/mapper.rb</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActionDispatch</span></span></div><div class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Routing</span></span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mapper</span></span></div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">add_route</span><span class="params">(action, options)</span></span></div><div class="line">        path = path_for_action(action, options.delete(<span class="symbol">:path</span>))</div><div class="line"></div><div class="line">        ...</div><div class="line"></div><div class="line">        mapping = Mapping.new(@set, @scope, URI.parser.escape(path), options)</div><div class="line">        app, conditions, requirements, defaults, as, anchor = mapping.to_route</div><div class="line">        @set.add_route(app, conditions, requirements, defaults, as, anchor)</div><div class="line">      <span class="keyword">end</span></div><div class="line"></div><div class="line">      ...</div><div class="line"></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>在这里， @set 是我们之前提到的 RouteSet ，这里的 app 其实是 ActionDispatch::Routing::Dispatcher 的一个实例。 Dispatcher 类定义在 route_set.rb 中，这是 #call 的一个简单定义。</p>
<p>为了说的更清楚，想象一下我们正在通过URL /posts 访问我们的博客应用，它的路由指向了 Posts Controller 的 index 方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/actionpack/lib/action_dispatch/routing/route_set.rb</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActionDispatch</span></span></div><div class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Routing</span></span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span></span></div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></div><div class="line">        params = env[PARAMETERS_KEY]</div><div class="line">        prepare_params!(params) </div><div class="line">        <span class="comment"># params = &#123;:action=&gt;"index", :controller=&gt;"posts"&#125;</span></div><div class="line"></div><div class="line">        controller = controller(params, @defaults.key?(<span class="symbol">:controller</span>))</div><div class="line">        <span class="comment"># controller = PostsController</span></div><div class="line"></div><div class="line">        dispatch(controller, params[<span class="symbol">:action</span>], env)</div><div class="line">      <span class="keyword">end</span></div><div class="line"></div><div class="line">      ...</div><div class="line"></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>在这里， controller 方法已经解析了控制器参数（比如 posts ），并且给了我们一个类（PostsController）的引用，得到了基本的参数哈希（params hash）。</p>
<p>现在，已经准备好了去调用控制器（controller）上的方法（aciton），来得到完整的响应（response）。以下是 dispatch 方法的定义：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/actionpack/lib/action_dispatch/routing/route_set.rb</span></div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(controller, action, env)</span></span></div><div class="line">  controller.action(action).call(env)</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>到这里，我们成功地将 route 映射到了一个 controller/action ，作为下一个 post 处理的请求（request）被压入ActionController工作栈。</p>
<p>路由是 Rails 中一个相当复杂的一个部分，他的方法链很长。像之前所说的，我们并没有必要了解它的全部细节。Rails 具有魔力的地方就是它为你隐藏了所有这些细节。当然去探索这整个执行过程到底是如何发生的是一件很有趣的事情。</p>
<h3 id="译者总结："><a href="#译者总结：" class="headerlink" title="译者总结："></a>译者总结：</h3><p>实际上每个存在的 Controller 和 Action 的组合都是一个 Rack App ，假设它们存在于一个集合 rack_app_set 中；同时假设所有系统可接受的合法URL的集合为 URL_set 。</p>
<p>则路由为函数：</p>
<blockquote>
<p>ƒ: <em>URL_set</em> → <em>rack_app_set</em></p>
</blockquote>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/06/26/2015-06-26-rails-request-to-response-one/">
  <time datetime="2015-06-26T10:55:27.000Z">
    2015-06-26
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/06/26/2015-06-26-rails-request-to-response-one/">[Rails] 从Request到Response（1）</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p><em>本文翻译自：<a href="http://andrewberls.com/blog/post/rails-from-request-to-response-part-1--introduction" target="_blank" rel="external">Rails from Request to Response 系列</a>；个人选择了自己感兴趣的部分进行翻译，需要阅读原文的同学请戳前面的链接。</em></p>
<h2 id="第一部分-导言（Introduction）"><a href="#第一部分-导言（Introduction）" class="headerlink" title="第一部分 导言（Introduction）"></a>第一部分 导言（Introduction）</h2><h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><p>在讲 Rails 调用栈之前，先简单介绍一下不同服务器应用的作用，其中并不会涉及到各个服务器应用（比如<code>Thin</code>和<code>Unicorn</code>或<code>Nginx</code>）的细节，因为文章的重点是讲 Rails 端的一些东西。</p>
<p>这里举一个<code>Unicorn</code>的简单例子，管窥整个 Rails 应用。</p>
<h3 id="Unicorn架构"><a href="#Unicorn架构" class="headerlink" title="Unicorn架构"></a>Unicorn架构</h3><p><code>Unicorn</code>是一个实现了<a href="http://rack.github.io/" target="_blank" rel="external">Rack</a>接口的服务器应用，通过多个<code>Worker</code>并行处理请求（request）。启动时，主进程会将 Rails App 代码加在到内存中，随后以加载进来内存为原料进行复制，生成一定数量的<code>Worker</code>，并对他们进行监控和信号捕获（比如被用作关闭和重启的QUIT，TERM，USR1信号等等）。这些<code>Worker</code>负责处理的一个个真实的Web请求（request）。</p>
<p>下图是<code>Unicorn</code>的架构（<a href="https://github.com/blog/517-unicorn" target="_blank" rel="external">这幅图片</a>来自Github一篇很棒的文章）：<br><img src="http://7xjra1.com1.z0.glb.clouddn.com/unicorn_architecture.png" alt="Unicorn Architecture"></p>
<p>这些<code>Worker</code>从共享的<code>Socket</code>中读取HTTP请求（request），并将它们发给Rails应用。随后得到响应（response），写回到共享的<code>Socket</code>中。这个过程中的大部份都发生在Unicorn<code>HttpServer</code>类的<code>#process_client</code>方法中，下面是相关部分的代码：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># unicorn/lib/unicorn/http_server.rb</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_client</span><span class="params">(client)</span></span></div><div class="line">  status, headers, body = @app.call(env = @request.read(client))</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  http_response_write(client, status, headers, body,</div><div class="line">                      @request.response_start_sent)</div><div class="line"></div><div class="line">  client.shutdown</div><div class="line">  client.close</div><div class="line"><span class="keyword">rescue</span> =&gt; e</div><div class="line">  handle_error(client, e)</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p><em>其中省略了一些关于<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.1.1" target="_blank" rel="external">HTTP 100</a>状态处理和<a href="http://blog.phusion.nl/2013/01/23/the-new-rack-socket-hijacking-api/" target="_blank" rel="external">Rack socket hijacking</a>相关的代码，感兴趣的话可以阅读<a href="https://github.com/defunkt/unicorn/blob/728b2c70cda7787a80303c6fa2c2530dcb490c90/lib/unicorn/http_server.rb#L570" target="_blank" rel="external">完整版本</a>。</em></p>
<p>我们可以看到，这个方法的核心逻辑相当的简明！</p>
<p>第一行是<a href="https://github.com/rack/rack/blob/master/SPEC" target="_blank" rel="external">Rack specification</a>：Rake App 其实就是一个 Ruby Object，我们只需要为它写一个可以接受 hash 参数<code>env</code>的<code>#call</code>方法，让它的返回<code>[status, headers, body]</code>（译者：还不是很明白<code>Rake</code>是什么鬼的同学可以去看一下这个<a href="http://railscasts-china.com/episodes/the-rails-initialization-process-by-kenshin54" target="_blank" rel="external">视频</a>，亲测好评）。</p>
<p>这个就是<code>Rails</code>，<code>Sinatra</code>，<code>Padrino</code>等那些兼容了Rake接口的框架的核心。回到<code>#process_client</code>方法，可以看到，我们向<code>@app</code>的<code>#call</code>方法传递 env 参数，并在 client 关闭之前，将响应（response）写回。</p>
<p>你没猜错，这个<code>@app</code>就是我们的 Rails 项目，我们来看他的声明：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># blog/config/application.rb</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Blog</span></span></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Application</span> &lt; Rails::Application</span></div><div class="line">    ...</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>这就是 Rails 调用栈的入口，但是如果你仔细观察，你会发现<code>#call</code>并没有定义在<code>Blog::Application</code>，而是被声明在了父类<code>Rails::Application</code>中。</p>
<p>现在开始，我们需要了解 Rails 应用的继承机制，以及一个请求（request）是如何在 Rails 内部被处理的。</p>
<h3 id="Rails-Application-and-Engines"><a href="#Rails-Application-and-Engines" class="headerlink" title="Rails Application and Engines"></a>Rails Application and Engines</h3><p>我们之前提到，整个 Rails 应用的入口<code>#call</code>被定义在了<code>Rails::Application</code>中，我们通过继承来使用它。这里是它的定义（<a href="https://github.com/rails/rails/blob/0dea33f770305f32ed7476f520f7c1ff17434fdc/railties/lib/rails/application.rb#L139" target="_blank" rel="external">源码</a>）：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/railties/lib/rails/application.rb</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Rails</span></span></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Application</span> &lt; Engine</span></div><div class="line"></div><div class="line">    <span class="comment"># Implements call according to the Rack API. It simply</span></div><div class="line">    <span class="comment"># dispatches the request to the underlying middleware stack.</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></div><div class="line">      env[<span class="string">"ORIGINAL_FULLPATH"</span>] = build_original_fullpath(env)</div><div class="line">      env[<span class="string">"ORIGINAL_SCRIPT_NAME"</span>] = env[<span class="string">"SCRIPT_NAME"</span>]</div><div class="line">      <span class="keyword">super</span>(env)</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>这里并没有什么东西，大部分功能通过调用<code>super</code>来执行。如果我们跟着代码看，可以发现<code>Rails::Application</code>类继承于<code>Rails::Engine</code>类。如果你熟悉<a href="http://edgeguides.rubyonrails.org/engines.html" target="_blank" rel="external">Rails engines</a>，你会惊喜地发现，<code>Rails::Application</code>就是一个超级<code>engine</code>!</p>
<p>我们来看看<code>Engine</code>类中的<code>#call</code>方法：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/railties/lib/rails/engine.rb</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Rails</span></span></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Engine</span> &lt; Railtie</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></div><div class="line">      env.merge!(env_config)</div><div class="line">      <span class="keyword">if</span> env[<span class="string">'SCRIPT_NAME'</span>]</div><div class="line">        env.merge! <span class="string">"ROUTES_<span class="subst">#&#123;routes.object_id&#125;</span>_SCRIPT_NAME"</span> =&gt; env[<span class="string">'SCRIPT_NAME'</span>].dup</div><div class="line">      <span class="keyword">end</span></div><div class="line">      app.call(env)</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>所以，<code>Engine</code>类继承于<code>Rails::Railtie</code>。通过观察<a href="https://github.com/rails/rails/blob/0dea33f770305f32ed7476f520f7c1ff17434fdc/railties/lib/rails/railtie.rb" target="_blank" rel="external">源码</a>，我们可以发现Railtie是Rails框架的核心，他为<code>initializers</code>，<code>config keys</code>，<code>generators</code>和<code>rake tasks</code>等提供钩子方法。</p>
<p>所有Rails的主要部件（<code>ActionMailer</code>，<code>ActionView</code>，<code>ActionController</code>和<code>ActiveRecord</code>）都是一个<code>Railtie</code>，这也就是为什么你可以随意拆装组合这些部件。</p>
<p>在<code>Engine</code>的<code>#call</code>方法中我们看到了<code>#call</code>的另一个代理方法（delegation），这里的<code>app</code>代表的是什么？在同一个文件中，我们发现了他的定义：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/railties/lib/rails/engine.rb</span></div><div class="line"></div><div class="line"><span class="comment"># Returns the underlying rack application for this engine.</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span></span></div><div class="line">  @app <span class="params">||</span>= <span class="keyword">begin</span></div><div class="line">    config.middleware = config.middleware.merge_into(default_middleware_stack)</div><div class="line">    config.middleware.build(endpoint)</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>现在我们到了一个牛逼的位置。这个engine构造了一个类似Rack application的中间件，并将<code>#call</code>方法代理（delegate）给它，他的终点是我们应用的<code>routes</code>，<code>ActionDispatch::Routing::RouteSet</code>类的一个实例。</p>
<p>Rack middleware可以用来「过滤」请求（request）和响应（response），并且可以将一个请求（request）处理过程分解成多个步骤，并视为一个「管道」进行处理，比如：处理权限认证，缓存等等。</p>
<p>你可以通过执行<code>rake middleware</code>来列出一个应用所使用的全部中间件。这里是我对 Blog 应用执行这条指令所得到的结果：<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ RAILS_ENV=production rake middleware</div><div class="line">use Rack::Sendfile</div><div class="line">use #<span class="xml"><span class="tag">&lt;<span class="name">ActiveSupport::Cache::Strategy::LocalCache::Middleware:0x007f7ffb206f20</span>&gt;</span></span></div><div class="line">use Rack::Runtime</div><div class="line">use Rack::MethodOverride</div><div class="line">use ActionDispatch::RequestId</div><div class="line">use Rails::Rack::Logger</div><div class="line">use ActionDispatch::ShowExceptions</div><div class="line">use ActionDispatch::DebugExceptions</div><div class="line">use ActionDispatch::RemoteIp</div><div class="line">use ActionDispatch::Callbacks</div><div class="line">use ActiveRecord::ConnectionAdapters::ConnectionManagement</div><div class="line">use ActiveRecord::QueryCache</div><div class="line">use ActionDispatch::Cookies</div><div class="line">use ActionDispatch::Session::CookieStore</div><div class="line">use ActionDispatch::Flash</div><div class="line">use ActionDispatch::ParamsParser</div><div class="line">use Rack::Head</div><div class="line">use Rack::ConditionalGet</div><div class="line">use Rack::ETag</div><div class="line">run Blog::Application.routes</div></pre></td></tr></table></figure></p>
<p>其中的大部分都不会讲，因为没有必要去了解全部这些中间件，即使一个请求（request），在到达<code>Blog::Application.routes</code>之前，会途径列表中从上到下所有的中间件。</p>
<p>到这里，我们已经完成了<code>App server / Rails application stack</code>的导言部分的介绍，接下来会着重介绍<code>Rails routing / dispatch stack</code>。</p>
<h3 id="译者总结"><a href="#译者总结" class="headerlink" title="译者总结"></a>译者总结</h3><p>我们可以讲<code>rake app</code>简化地表示为一个函数：</p>
<blockquote>
<p>ƒ: <em>env_set</em> → <em>{ [status, headers, body] }</em></p>
</blockquote>
<p><code>Rails app</code>其实就是若干个函数的嵌套，逐层对输入的<code>env</code>和返回<code>[status, headers, body]</code>进行加工。整个Rails的执行过程，不过如此。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">env</span>(<span class="number">1</span>) → <span class="keyword">env</span>(<span class="number">2</span>) → ... → <span class="keyword">env</span>(i) → ... <span class="keyword">env</span>(n)</div></pre></td></tr></table></figure>
<p>令：<code>s: [status, headers, body]</code><br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">s</span><span class="params">(n)</span> → <span class="title">s</span><span class="params">(n-<span class="number">1</span>)</span> → ... → <span class="title">s</span><span class="params">(i)</span> → ... <span class="title">s</span><span class="params">(<span class="number">1</span>)</span></span></div></pre></td></tr></table></figure></p>
<p>看完这篇文章后，终于理解了<a href="http://robbinfan.com/blog/40/ruby-off-rails" target="_blank" rel="external">《Ruby社区应该去Rails化了》</a>中这段话的意思：</p>
<blockquote>
<h3 id="Rails为何不适合做Web-Service"><a href="#Rails为何不适合做Web-Service" class="headerlink" title="Rails为何不适合做Web Service?"></a>Rails为何不适合做Web Service?</h3><p>我发现了一个有意思的现象，最早的一批用Ruby开发Web Service服务的网站，都选择了用Rails开发，而在最近几年又不约而同抛弃Rails重写Web服务框架。当初用Rails的原因很简单，因为产品早期起步，不确定性很高，使用Rails快速开发，可以最大限度节约开发成本和时间。但为何当请求量变大以后，Rails不再适合了呢？</p>
<p>这主要是因为Rails本身是一个full-stack的Web框架，所有的设计目标就是为了开发Website，所以Rails框架封装过于厚重，对于需要更高性能更轻薄的Web Service应用场景来说，暴露出来了很多缺陷：</p>
<h4 id="Rails调用堆栈过深，URL请求处理性能很差"><a href="#Rails调用堆栈过深，URL请求处理性能很差" class="headerlink" title="Rails调用堆栈过深，URL请求处理性能很差"></a>Rails调用堆栈过深，URL请求处理性能很差</h4><p>Rails的设计目标是提供Web开发的 最佳实践 ，所以无论你需要不需要，Rails默认提供了开发Website所有可能的组件，但其中绝大部分你可能一辈子都用不上。例如Rails项目默认添加了20个middleware，但其中10个都是可以去掉的，我们自己的项目当中手工删除了这些middleware：</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">config.middleware.delete <span class="string">'Rack::Cache'</span>   <span class="comment"># 整页缓存，用不上</span></div><div class="line">config.middleware.delete <span class="string">'Rack::Lock'</span>    <span class="comment"># 多线程加锁，多进程模式下无意义</span></div><div class="line">config.middleware.delete <span class="string">'Rack::Runtime'</span> <span class="comment"># 记录X-Runtime（方便客户端查看执行时间）</span></div><div class="line">config.middleware.delete <span class="string">'ActionDispatch::RequestId'</span> <span class="comment"># 记录X-Request-Id（方便查看请求在群集中的哪台执行）</span></div><div class="line">config.middleware.delete <span class="string">'ActionDispatch::RemoteIp'</span>  <span class="comment"># IP SpoofAttack</span></div><div class="line">config.middleware.delete <span class="string">'ActionDispatch::Callbacks'</span> <span class="comment"># 在请求前后设置callback</span></div><div class="line">config.middleware.delete <span class="string">'ActionDispatch::Head'</span>      <span class="comment"># 如果是HEAD请求，按照GET请求执行，但是不返回body</span></div><div class="line">config.middleware.delete <span class="string">'Rack::ConditionalGet'</span>      <span class="comment"># HTTP客户端缓存才会使用</span></div><div class="line">config.middleware.delete <span class="string">'Rack::ETag'</span>    <span class="comment"># HTTP客户端缓存才会使用</span></div><div class="line">config.middleware.delete <span class="string">'ActionDispatch::BestStandardsSupport'</span> <span class="comment"># 设置X-UA-Compatible, 在nginx上设置</span></div></pre></td></tr></table></figure>
<blockquote>
<p>其中最夸张的是ActionDispatch::RequestIdmiddleware，只有在大型应用部署在群集环境下进行线上调试才可能用到的功能，有什么必要做成默认的功能呢？ Rails的哲学是：提供最全的功能集给你，如果你用不到，你自己手工一个一个关闭掉 ，但是这样带来的结果就是默认带了太多不必要的冗余功能，造成性能损耗极大。</p>
<p>我们看一个Ruby web框架请求处理性能评测 ，这个评测不访问数据库，也不测试并发性能，主要是测试框架处理URL请求路由，渲染文本，返回结果的处理速度。</p>
<p>Rack: 1570.43 request/s<br>Campig: 1166.16 request/s<br>Sinatra: 912.81 request/s<br>Padrino: 648.68 request/s<br>Rails: 291.27 request/s</p>
<p>Sinatra至少是Rails速度的3倍以上。</p>
</blockquote>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/06/25/2015-06-25-charlie-munger-on-the-psychology-of-human-misjudgment-two/">
  <time datetime="2015-06-25T14:50:27.000Z">
    2015-06-25
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/06/25/2015-06-25-charlie-munger-on-the-psychology-of-human-misjudgment-two/">人类误判心理（2）</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>作者：查理·芒格</p>
<h3 id="My-second-factor-is-simple-psychological-denial"><a href="#My-second-factor-is-simple-psychological-denial" class="headerlink" title="My second factor is simple psychological denial."></a>My second factor is simple psychological denial.</h3><p><strong>第二条：单纯的心理学上的「否定」</strong></p>
<p><em>This first really hit me between the eyes when a friend of our family had a super-athlete, super-student son who flew off a carrier in the north Atlantic and never came back, and his mother, who was a very sane woman, just never believed that he was dead. And, of course, if you turn on the television, you’ll find the mothers of the most obvious criminals that man could ever diagnose, and they all think their sons are innocent. That’s simple psychological denial. The reality is too painful to bear, so you just distort it until it’s bearable. We all do that to some extent, and it’s a common psychological misjudgment that causes terrible problems.</em></p>
<p>译者：一则小故事，不作具体翻译。了解「精神分析」理论的同学肯定都知道，其实说的就是所谓「心理防卫机制」中的「否认」<sup>[<a href="/self-defense-mechanism#bookmark_denial">1</a>]</sup>。借此机会向大家推荐「心理防卫机制」，希望可以帮助各位更加了解自己。鉴于有些同学无法访问维基百科，将原文<a href="/self-defense-mechanism">复制了一份</a>过来。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/06/24/2015-06-24-charlie-munger-on-the-psychology-of-human-misjudgment-one/">
  <time datetime="2015-06-24T05:20:27.000Z">
    2015-06-24
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/06/24/2015-06-24-charlie-munger-on-the-psychology-of-human-misjudgment-one/">人类误判心理（1）</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>作者：查理·芒格（伯克夏·哈撒韦公司董事会副主席，沃伦·巴菲特的搭档）</p>
<p>本文是作者1995年在哈佛法学院的演讲 <a href="http://www.rbcpa.com/Mungerspeech_june_95.pdf" target="_blank" rel="external">原文链接</a></p>
<h3 id="First-Under-recognition-of-the-power-of-what-psychologists-call-‘reinforcement’-and-economists-call-‘incentives-’"><a href="#First-Under-recognition-of-the-power-of-what-psychologists-call-‘reinforcement’-and-economists-call-‘incentives-’" class="headerlink" title="First: Under-recognition of the power of what psychologists call ‘reinforcement’ and economists call ‘incentives.’"></a>First: Under-recognition of the power of what psychologists call ‘reinforcement’ and economists call ‘incentives.’</h3><p><strong>第一条：低估 心理学家所谓的「强化」 / 经济学家所谓的「激励」的 效果。</strong></p>
<p><em>Well you can say, “Everybody knows that.” Well I think I’ve been in the top 5% of my age cohort all my life in understanding the power of incentives, and all my life I’ve underestimated it. And never a year passes but I get some surprise that pushes my limit a little farther.</em></p>
<p>好吧，你们可能说俺们都知道，然而你们知道的那些并没有什么卵用。老子是俺们这辈人里最了解「激励」的人之一，我这大半辈子还都低估了它有多屌，甚至到现在老子每年还老丁<sup><a href="#bookmark_laoding">[1]</a></sup>能在这玩意上学到新东西，得到新惊喜。</p>
<p><em>One of my favorite cases about the power of incentives is the Federal Express case. The heart and soul of the integrity of the system is that all the packages have to be shifted rapidly in one central location each night. And the system has no integrity if the whole shift can’t be done fast. And Federal Express had one hell of a time getting the thing to work. And they tried moral suasion, they tried everything in the world, and finally somebody got the happy thought that they were paying the night shift by the hour, and that maybe if they paid them by the shift, the system would work better. And lo and behold, that solution worked.</em></p>
<p>俺最喜欢的一个关于「激励」的案例来自联邦快递：对这家公司来说，最重要的就是在每天夜里，包裹必须从一个中央位置被快速地转运出去。而且，如果不足够快的话，这个系统基本上就屁用不顶了。之前该公司就经常被这事折磨得欲仙欲死。他们试着和快递员小哥儿们进行道德教育，和其他所有能想到的奇奇怪怪的方法，然而并没有什么卵用。最后有个人想出了一招，按小时给晚班工人计费。如果给小哥儿们按照轮班发钱，这个系统就更好地运转起来了。你看，这回牛逼了吧。</p>
<p><em>Early in the history of Xerox, Joe Wilson, who was then in the government, had to go back to Xerox because he couldn’t understand how their better, new machine was selling so poorly in relation to their older and inferior machine. Of course when he got there he found out that the commission arrangement with the salesmen gave a tremendous incentive to the inferior machine.</em></p>
<p>在Xerox公司的早期，Joe Wilson这货从他的政府工作上回到Xerox，因为他不知道为啥更牛逼的新机器比渣渣的旧机器卖的还差。妈蛋的，他发现销售人员的佣金制度竟然鼓励他们卖老机器！！！</p>
<p><em>And here at Harvard, in the shadow of B.F. Skinner – there was a man who really was into reinforcement as a powerful thought, and, you know, Skinner’s lost his reputation in a lot of places, but if you were to analyze the entire history of experimental science at Harvard, he’d be in the top handful. His experiments were very ingenious, the results were counterintuitive, and they were important. It is not given to experimental science to do better. What gummed up Skinner’s reputation is that he developed a case of what I always call man-with-a-hammer syndrome: to the man with a hammer, every problem tends to look pretty much like a nail. And Skinner had one of the more extreme cases in the history of Academia, and this syndrome doesn’t exempt bright people. It’s just a man with a hammer…and Skinner is an extreme example of that. And later, as I go down my list, let’s go back and try and figure out why people, like Skinner, get man-with-a-hammer syndrome.</em></p>
<p>在哈尔滨服装学院，有一个叫B.F. Skinner的人，真的视「强化」为一个强有力的思维模式。他在很多地方都名誉受损，不过从哈佛实验科学的历史上看，他算是很屌的了。他的实验很有创造性，实验结果也是反直觉而且重要的。他没能将实验科学做的更好。我经常称将他名誉搞差的原因叫做「王大锤综合征」：对于手里拿着锤子的同学来说，所有问题都像钉子。斯金纳是学术史上的一个极端案例，然而有些明白人也会有这个问题。我先按我本儿上接着说，等会再说为啥大家会得「王大锤综合症」。</p>
<p><em>Incidentally, when I was at the Harvard Law School there was a professor, naturally at Yale, who was derisively discussed at Harvard, and they used to say, “Poor old Blanchard. He thinks declaratory judgments will cure cancer.” And that’s the way Skinner got. And not only that, he was literary, and he scorned opponents who had any different way of thinking or thought anything else was important. This is not a way to make a lasting reputation if the other people turn out to also be doing something important.</em></p>
<p>Btw，我当年在哈佛法学院的时候，有一个教授，他认为宣告判决将治愈癌症，就像Skinner一样。不止如此，他精通文学，经常嘲讽和自己有不同想法的对手。这绝壁不是个维系持久名誉的方法（我擦，这段好难翻译。因为是演讲，可能是作者随便说些有的没的。</p>
<hr>
<p><em><span id="bookmark_laoding">[1]</span> 老丁：经常的意思；例句：王雪冰常说：“我老丁（经常）找老丁（丁麒玮）玩，老丁（丁麒玮）老丁（经常）不出来。”</em></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/06/22/2015-06-22-seven-concurrency-models-in-seven-weeks-dining-philosophers-problem/">
  <time datetime="2015-06-22T03:20:27.000Z">
    2015-06-22
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/06/22/2015-06-22-seven-concurrency-models-in-seven-weeks-dining-philosophers-problem/">并发模型学习 (4)</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h4 id="哲学家用餐问题（Dining-philosophers-problem）"><a href="#哲学家用餐问题（Dining-philosophers-problem）" class="headerlink" title="哲学家用餐问题（Dining philosophers problem）"></a><a href="https://zh.wikipedia.org/zh-cn/%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90%E9%97%AE%E9%A2%98" target="_blank" rel="external">哲学家用餐问题（Dining philosophers problem）</a></h4><p>简单来说：有五个哲学家坐在一张圆桌上，每个人之间放着一只餐叉，这样桌上就有五只餐叉。哲学家只会做两件事，吃饭，或者思考。吃东西的时候，他们就停止思考，思考的时候也停止吃东西。<br><img src="http://7xjra1.com1.z0.glb.clouddn.com/Dining_philosophers.png" alt="来自Wikipedia"></p>
<p>是的，他们每个人都会用到别人用过的餐叉，开不开心。</p>
<p>这个例子一般用来说明死锁问题，经典的场景之一：一名哲学家拿起了自己左手的餐叉，并为其加锁（以免同时被自己左边的哲学家拿到），而后等待自己右手的餐叉锁的释放。</p>
<p>然而，如果五个哲学家同时处于这个状态，就会死锁。</p>
<p>举个栗子：<br><code>Chopstick.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chopstick</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>Philosopher.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> Chopstick left, right;</div><div class="line">    <span class="keyword">private</span> Random random;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(Chopstick left, Chopstick right, <span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.left  = left; <span class="keyword">this</span>.right = right; <span class="keyword">this</span>.id = id;</div><div class="line">        random = <span class="keyword">new</span> Random();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                Thread.sleep( random.nextInt(<span class="number">1000</span>) );     <span class="comment">// Think for a while</span></div><div class="line">                <span class="keyword">synchronized</span> (left) &#123;                    <span class="comment">// Grab left chopstick</span></div><div class="line">                    System.out.println(<span class="string">"Philosopher#"</span> + id + <span class="string">" take left Chopstick"</span>);</div><div class="line"></div><div class="line">                    <span class="keyword">synchronized</span> (right) &#123;                 <span class="comment">// Grab right chopstick</span></div><div class="line">                        System.out.println(<span class="string">"Philosopher#"</span> + id + <span class="string">" take right Chopstick"</span>);</div><div class="line">                        Thread.sleep( random.nextInt(<span class="number">1000</span>) ); <span class="comment">// Eat for a while</span></div><div class="line">                    &#125;</div><div class="line">                    System.out.println(<span class="string">"Philosopher#"</span> + id + <span class="string">" put right chopsticks"</span>);</div><div class="line">                &#125;</div><div class="line">                System.out.println(<span class="string">"Philosopher#"</span> + id + <span class="string">" put left chopsticks"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>DiningPhilosophers.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiningPhilosophers</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        Philosopher[] philosophers = <span class="keyword">new</span> Philosopher[<span class="number">5</span>];</div><div class="line">        Chopstick[] chopsticks     = <span class="keyword">new</span> Chopstick[<span class="number">5</span>];</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i)</div><div class="line">            chopsticks[i] = <span class="keyword">new</span> Chopstick();</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i) &#123;</div><div class="line">            philosophers[i] = <span class="keyword">new</span> Philosopher(chopsticks[i], chopsticks[(i + <span class="number">1</span>) % <span class="number">5</span>], i);</div><div class="line">            philosophers[i].start();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i)</div><div class="line">            philosophers[i].join();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个栗子属于可以锁得死死的那种。</p>
<p>因为全局的多个代码块可能会共同使用一些锁，所以我们可以通过为所有的锁添加一个偏序关系，来避免死锁状态的产生。</p>
<p><code>Philosopher.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> Chopstick first, secound;</div><div class="line">    <span class="keyword">private</span> Random random;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(Chopstick left, Chopstick right, <span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.id = id;</div><div class="line">        <span class="keyword">if</span> (left.getId() &lt; right.getId()) &#123;</div><div class="line">            <span class="keyword">this</span>.first = left; <span class="keyword">this</span>.second = right;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.first = right; <span class="keyword">this</span>.second = left;</div><div class="line">        &#125;</div><div class="line">        random = <span class="keyword">new</span> Random();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                Thread.sleep(random.nextInt(<span class="number">1000</span>));</div><div class="line">                <span class="keyword">synchronized</span>(first) &#123;</div><div class="line">                    System.out.println(<span class="string">"Philosopher#"</span> + id + <span class="string">" take Chopstick#"</span> + first.getId());</div><div class="line"></div><div class="line">                    <span class="keyword">synchronized</span>(second) &#123;</div><div class="line">                        System.out.println( <span class="string">"Philosopher#"</span> +</div><div class="line">                            id +<span class="string">" take Chopstick#"</span> + second.getId() );</div><div class="line">                        Thread.sleep( random.nextInt(<span class="number">1000</span>) );</div><div class="line">                    &#125;</div><div class="line">                    System.out.println(<span class="string">"Philosopher#"</span> + id + <span class="string">" put Chopstick#"</span> + second.getId());</div><div class="line">                &#125;</div><div class="line">                System.out.println(<span class="string">"Philosopher#"</span> + id + <span class="string">" put Chopstick#"</span> + first.getId());</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="外星方法"><a href="#外星方法" class="headerlink" title="外星方法"></a>外星方法</h4><p>这里我们构造有一个类从一个URL进行下载, 用<code>ProgressListeners</code>监听下载速度<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Downloader</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> InputStream in;</div><div class="line">    <span class="keyword">private</span> OutputStream out;</div><div class="line">    <span class="keyword">private</span> ArrayList&lt;ProgressListener&gt; listeners;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Downloader</span><span class="params">(URL url, String outputFilename)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        in = url.openConnect().getInputSteam();</div><div class="line">        out = <span class="keyword">new</span> FileOutputStream(outputFilename);</div><div class="line">        listeners = <span class="keyword">new</span> ArrayList&lt;ProgressListener&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(ProgressListener listener)</span> </span>&#123;</div><div class="line">        listeners.add(listener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(ProgressListener listener)</span> </span>&#123;</div><div class="line">        listeners.remove(listener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">updateProgress</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (ProgressListener listener: listeners)</div><div class="line">            listener.onProgress(n);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> n = <span class="number">0</span>, total = <span class="number">0</span>;</div><div class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> ( (n = in.read(buffer)) != -<span class="number">1</span> ) &#123;</div><div class="line">                out.write(buffer, <span class="number">0</span>, n);</div><div class="line">                total += n;</div><div class="line">                updateProgress(total);</div><div class="line">            &#125;</div><div class="line">            out.flush();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><em>未完待续</em></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/06/21/2015-06-21-seven-concurrency-models-in-seven-weeks-memory-visibility/">
  <time datetime="2015-06-21T03:20:27.000Z">
    2015-06-21
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/06/21/2015-06-21-seven-concurrency-models-in-seven-weeks-memory-visibility/">并发模型学习 (3)</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h4 id="优化的副作用"><a href="#优化的副作用" class="headerlink" title="优化的副作用"></a>优化的副作用</h4><p><img src="http://7xjra1.com1.z0.glb.clouddn.com/the thinker.jpg" alt="What is the meaning of my life?"></p>
<p>由于没有通读过Ruby源码，无法确定这个Bug是否能用Ruby来复现，先用Java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Puzzle</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> answerReady = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> answer = <span class="number">0</span>;</div><div class="line">    <span class="keyword">static</span> Thread t1 = <span class="keyword">new</span> Thread() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            answer = <span class="number">42</span>;</div><div class="line">            answerReady = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">static</span> Thread t2 = <span class="keyword">new</span> Thread() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (answerReady)</div><div class="line">                System.out.println(<span class="string">"The meaning of life is: "</span> + answer);</div><div class="line">            <span class="keyword">else</span></div><div class="line">                System.out.println(<span class="string">"I don't know the answer"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        t1.start(); t2.start();</div><div class="line">        t1.join(); t2.join();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据线程执行的时序，这段代码的输出可能是：<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The meaning of life is: 42</div></pre></td></tr></table></figure></p>
<p>或者是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">I don&apos;t know the answer</div></pre></td></tr></table></figure></p>
<p>但是还有一种结果可能是：<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The meaning of life is: 0</div></pre></td></tr></table></figure></p>
<p>这说明了，当<code>answerReady</code>为<code>true</code>时<code>answer</code>可能为0！</p>
<p>就好像第六行和第七行颠倒了执行顺序。但是乱序执行是完全可能发生的：</p>
<ol>
<li>编译器的静态优化可以打乱代码的执行顺序（编译原理）</li>
<li>JVM的动态有话也会打乱代码的执行顺序（JVM）</li>
<li>硬件可以通过乱序执行来优化其性能（计算机体系结构）</li>
</ol>
<p>比乱序执行更糟糕的时，有时一个线程产生的修改可能对另一个线程不可见，</p>
<p>如果讲<code>run()</code>写成：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (!answerReady)</div><div class="line">        Thread.sleep(<span class="number">100</span>);</div><div class="line">    System.out.println(<span class="string">"The meaning of life is: "</span> + answer);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>answerReady</code>可能不会变成<code>true</code>代码运行后无法退出。</p>
<p>显然，我们需要一个明确的标准来告诉我们，优化会产生什么副作用影响，这就是<code>Java</code>内存模型(其他语言应该也有类似的东西)。Btw，经过本天才的多次试验，Ruby这边可以复现啦！！！</p>
<p>复现代码：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">'singleton'</span>  </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Puzzle</span></span></div><div class="line">  <span class="keyword">include</span> Singleton</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></div><div class="line">    @answer_ready = <span class="literal">false</span></div><div class="line">    @answer       = <span class="number">0</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">thread1</span></span></div><div class="line">    Thread.new <span class="keyword">do</span></div><div class="line">      @answer       = <span class="string">'eat'</span></div><div class="line">      @answer_ready = <span class="literal">true</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">thread2</span></span></div><div class="line">    Thread.new <span class="keyword">do</span></div><div class="line">      meaning_of_life = <span class="string">"The meaning of life is: <span class="subst">#&#123;@answer&#125;</span>"</span></div><div class="line">      no_answer       = <span class="string">"I don't know the answer"</span></div><div class="line">      puts @answer_ready ? meaning_of_life : no_answer</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span></div><div class="line">    [thread1, thread2].each(&amp;<span class="symbol">:join</span>)</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">Puzzle.instance.main</div></pre></td></tr></table></figure></p>
<p>实验过程：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="keyword">while</span> [ <span class="string">"<span class="variable">$result</span>"</span> != <span class="string">"The meaning of life is: 0"</span> ]; <span class="keyword">do</span></div><div class="line">  result=<span class="string">"<span class="variable">$(ruby test.rb)</span>"</span></div><div class="line">  <span class="built_in">echo</span> <span class="variable">$result</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure></p>
<p>实验结果：<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">➜  /tmp ruby:(system: ruby 2.1.5p273)</div><div class="line">$ sh test.sh</div><div class="line">The meaning of life is: eat</div><div class="line">The meaning of life is: eat</div><div class="line">I don't know the answer</div><div class="line">The meaning of life is: eat</div><div class="line">I don't know the answer</div><div class="line">I don't know the answer</div><div class="line">The meaning of life is: 0</div></pre></td></tr></table></figure></p>
<h4 id="内存可见性"><a href="#内存可见性" class="headerlink" title="内存可见性"></a>内存可见性</h4><p><code>Java</code>内存模型定义了何时一个线程对内存的修改对另一个线程可见。基本原则是，如果读线程和写线程不进行同步，就不能保证可见性。</p>
<p>除了<code>increment</code>之外，<code>count</code>的<code>getter</code>方法也需要进行同步。否则<code>count</code>方法可能获得一个失效的值：对于前面交互的两个线程，<code>conter</code>在<code>join</code>之后调用因此是线程安全的。但这种设计为其他调用<code>conter</code>的方法埋下了隐患。</p>
<p>所以，「竞态条件」和「内存可见性」都可能让多线程程序运行结果出错。除此之外，还有一类问题：「死锁」。</p>
<h3 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h3><p><em><a href="http://www.infoq.com/cn/articles/java-memory-model-1" target="_blank" rel="external">深入理解Java内存模型系列</a></em><br><em><a href="http://www.domaigne.com/blog/computing/mutex-and-memory-visibility/" target="_blank" rel="external">内存可见性</a></em></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/06/20/2015-06-20-seven-concurrency-models-in-seven-weeks-mutex/">
  <time datetime="2015-06-20T03:20:27.000Z">
    2015-06-20
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/06/20/2015-06-20-seven-concurrency-models-in-seven-weeks-mutex/">并发模型学习 (2)</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h4 id="锁儿"><a href="#锁儿" class="headerlink" title="锁儿"></a>锁儿</h4><p>多个线程共享内存时，避免同时修改同一个部分内存造成的问题，需要用<strong>锁</strong>达到线程互斥的目的。某一时间，至多有一个线程持有锁。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Counter</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></div><div class="line">        @count = <span class="number">0</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">increment</span></span></div><div class="line">        @count += <span class="number">1</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">count</span></span></div><div class="line">        @count</div><div class="line">    <span class="keyword">end</span></div><div class="line"> <span class="keyword">end</span></div><div class="line">counter = Counter.new</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread</span><span class="params">(counter)</span></span></div><div class="line">  <span class="number">10_000</span>.times &#123; counter.increment &#125;</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">t1 = Thread.new &#123; thread(counter) &#125;</div><div class="line">t2 = Thread.new &#123; thread(counter) &#125;</div><div class="line"></div><div class="line">[t1, t2].each(&amp;<span class="symbol">:join</span>)</div><div class="line">puts counter.count</div></pre></td></tr></table></figure></p>
<p>执行结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">➜  /private/tmp ruby:(system: jruby 1.7.19)</div><div class="line">$ ruby test.rb</div><div class="line">13779</div><div class="line">➜  /private/tmp ruby:(system: jruby 1.7.19)</div><div class="line">$ ruby test.rb</div><div class="line">16440</div></pre></td></tr></table></figure></p>
<p>这段代码创建了一个<code>counter</code>对象和两个线程，每个线程调用<code>counter.increment</code> 10,000次。这段代码看上去很简单，但很脆弱。</p>
<p>几乎每次运行都将获得不同的结果，产生这个结果的原因是两个线程使用<code>counter.count</code>时发生了<strong>竞态条件</strong>（即代码行为取决于各操作的时序）</p>
<p>我们来看一下Java编译器是如何解释<code>++count</code>的。其字节码：<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">getfield <span class="attr">#2</span> ;<span class="comment">//获取count的值</span></div><div class="line">ico<span class="symbol">nst_1</span>    ;<span class="comment">//设置加数</span></div><div class="line">iadd        ;<span class="comment">//count加设置好的加数</span></div><div class="line">putfield <span class="attr">#2</span> ;<span class="comment">//将更新的值写回count</span></div></pre></td></tr></table></figure></p>
<p>这就是通称的<em>读-改-写</em>模式。</p>
<p>如果两个线程同时调用<code>increment</code>，线程1执行<code>getfield #2</code>，获取值42。在线程1执行其他动作之前，线程2也执行了<code>getfield #2</code>，获得值42。不过，现在两个线程都将获得的值加1，将43写回count中。导致<code>count</code>只被增加了一次。</p>
<p>竞态条件的解决方案：对<code>count</code>进行同步（synchronize）访问。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span></span></div><div class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:count</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></div><div class="line">    @count         = <span class="number">0</span></div><div class="line">    @counter_mutex = Mutex.new</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">increment</span></span></div><div class="line">    @counter_mutex.synchronize &#123; @count += <span class="number">1</span> &#125;</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread</span><span class="params">(counter)</span></span></div><div class="line">  <span class="number">10_000</span>.times &#123; counter.increment &#125;</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">counter = Counter.new</div><div class="line">t1 = Thread.new &#123; thread(counter) &#125;</div><div class="line">t2 = Thread.new &#123; thread(counter) &#125;</div><div class="line"></div><div class="line">[t1, t2].each(&amp;<span class="symbol">:join</span>)</div><div class="line">puts counter.count</div></pre></td></tr></table></figure></p>
<p>执行结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  /private/tmp ruby:(system: jruby 1.7.19)</div><div class="line">$ ruby test.rb</div><div class="line">20000</div></pre></td></tr></table></figure></p>
<p>线程进入<code>increment</code>方法时，获得<code>counter_mutex</code>锁，函数返回的时候释放该锁。同一时间最多有一个进程可以执行函数体，其他线程调用方法时将被阻塞，直到锁被释放。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  

  <nav id="pagination">
  
  
    <a href="/page/2/" class="next">Next</a>
  
  <div class="clearfix"></div>
</nav>

</div>
  </div>
  
  <div id="sidebar" class="widgets-bottom">
  
<div class="widget category">
  <h3 class="title">categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/开发工具/">开发工具</a><small>2</small></li>
  
    <li><a href="/categories/技术日志/">技术日志</a><small>2</small></li>
  
    <li><a href="/categories/流程方法/">流程方法</a><small>1</small></li>
  
    <li><a href="/categories/程序开发/">程序开发</a><small>6</small></li>
  
    <li><a href="/categories/解题报告/">解题报告</a><small>3</small></li>
  
    <li><a href="/categories/读书报告/">读书报告</a><small>13</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">tagcloud</h3>
  <div class="entry">
    <a href="/tags/MVC/" style="font-size: 10px;">MVC</a> <a href="/tags/activemq/" style="font-size: 10px;">activemq</a> <a href="/tags/c/" style="font-size: 18px;">c++</a> <a href="/tags/c-primer-plus/" style="font-size: 18px;">c++ primer plus</a> <a href="/tags/data-structure/" style="font-size: 10px;">data structure</a> <a href="/tags/dispatcher/" style="font-size: 10px;">dispatcher</a> <a href="/tags/gitcafe/" style="font-size: 10px;">gitcafe</a> <a href="/tags/hash/" style="font-size: 12px;">hash</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/homebrew/" style="font-size: 10px;">homebrew</a> <a href="/tags/leetcode/" style="font-size: 14px;">leetcode</a> <a href="/tags/linked-list/" style="font-size: 10px;">linked list</a> <a href="/tags/octopress/" style="font-size: 10px;">octopress</a> <a href="/tags/rails/" style="font-size: 18px;">rails</a> <a href="/tags/rake/" style="font-size: 10px;">rake</a> <a href="/tags/route/" style="font-size: 10px;">route</a> <a href="/tags/ruby/" style="font-size: 10px;">ruby</a> <a href="/tags/tree/" style="font-size: 10px;">tree</a> <a href="/tags/unicorn/" style="font-size: 10px;">unicorn</a> <a href="/tags/vim/" style="font-size: 10px;">vim</a> <a href="/tags/学习报告/" style="font-size: 16px;">学习报告</a> <a href="/tags/工作经验/" style="font-size: 10px;">工作经验</a> <a href="/tags/并发/" style="font-size: 16px;">并发</a> <a href="/tags/并行/" style="font-size: 16px;">并行</a> <a href="/tags/心理/" style="font-size: 14px;">心理</a> <a href="/tags/读书报告/" style="font-size: 20px;">读书报告</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">recent_posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/2016/05/18/2016-05-18-charlie-munger-on-the-psychology-of-human-misjudgment-three/">人类误判心理（3）</a>
      </li>
    
      <li>
        <a href="/2015/11/13/2015-11-13-the-core-value-of-sde/">软件工程师的核心价值</a>
      </li>
    
      <li>
        <a href="/2015/10/15/2015-10-15-b-tree/">B-Tree</a>
      </li>
    
      <li>
        <a href="/2015/06/28/2015-06-26-rails-request-to-response-two/">[Rails] 从Request到Response（2）</a>
      </li>
    
      <li>
        <a href="/2015/06/26/2015-06-26-rails-request-to-response-one/">[Rails] 从Request到Response（1）</a>
      </li>
    
  </ul>
</div>

</div>
  
  <footer id="footer"><div class="copyright">
  
  &copy; 2017 <a href="/">Bai, Yu</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://blog.dafengning.com/" target="_blank">Chong Zi</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//lib.sinaapp.com/js/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var disqus_shortname = 'everkeyword';

  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


<div id="rightfix" style="display:none;">


<a href="javascript:void(0)" id="gotop" class="fix_btn" onclick="gotop();" title="回到顶部"><i></i></a>
<script>
  function gotop(){
    $('html,body').animate({
        scrollTop : '0px'
      }, 800);
  }
  $(function(){
    _rightfix = $('#rightfix');
    $(window).scroll(function(){
      $sollTop = document.documentElement.scrollTop + document.body.scrollTop;
      if($sollTop > 350){
        _rightfix.show();
      }else{
        _rightfix.hide();
      }
    });
  });
</script>

</div>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>